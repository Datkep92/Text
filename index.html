<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trích Xuất Hóa Đơn Đơn Giản</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        h1, h2 {
            color: #2c3e50;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            margin-bottom: 10px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .progress {
            margin-top: 10px;
            display: none;
        }
        .status {
            margin-top: 5px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Trích Xuất Hóa Đơn Đơn Giản</h1>
        
        <div class="section">
            <h2>Tải lên hóa đơn PDF</h2>
            <input type="file" id="fileInput" accept=".pdf">
            <div class="progress" id="progressContainer">
                <progress id="progressBar" value="0" max="100"></progress>
                <div class="status" id="status">Sẵn sàng</div>
            </div>
            <button id="extractBtn">Trích xuất dữ liệu</button>
        </div>
        
        <div class="section">
            <h2>Nội dung trích xuất</h2>
            <textarea id="extractedText" readonly></textarea>
        </div>
        
        <div class="section">
            <h2>Bảng kê hàng hóa</h2>
            <table id="itemsTable">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Tên hàng hóa</th>
                        <th>Đơn vị</th>
                        <th>Số lượng</th>
                        <th>Đơn giá</th>
                        <th>Thành tiền</th>
                    </tr>
                </thead>
                <tbody id="itemsTableBody">
                    <!-- Dữ liệu hàng hóa sẽ được thêm vào đây -->
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h2>Chiết khấu thương mại</h2>
            <table id="discountsTable">
                <thead>
                    <tr>
                        <th>Mô tả</th>
                        <th>Giá trị</th>
                    </tr>
                </thead>
                <tbody id="discountsTableBody">
                    <!-- Dữ liệu chiết khấu sẽ được thêm vào đây -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Khởi tạo PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
        
        // DOM elements
        const fileInput = document.getElementById('fileInput');
        const extractBtn = document.getElementById('extractBtn');
        const extractedText = document.getElementById('extractedText');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const status = document.getElementById('status');
        const itemsTableBody = document.getElementById('itemsTableBody');
        const discountsTableBody = document.getElementById('discountsTableBody');
        
        // Xử lý khi nhấn nút trích xuất
        extractBtn.addEventListener('click', processInvoice);
        
        // Xử lý hóa đơn PDF
        async function processInvoice() {
            const file = fileInput.files[0];
            if (!file) {
                alert('Vui lòng chọn file PDF hóa đơn trước');
                return;
            }
            
            progressContainer.style.display = 'block';
            status.textContent = 'Đang xử lý...';
            progressBar.value = 0;
            
            try {
                // Chuyển PDF thành hình ảnh
                const images = await pdfToImages(file);
                let fullText = '';
                
                // Xử lý từng trang với Tesseract
                for (let i = 0; i < images.length; i++) {
                    status.textContent = `Đang xử lý trang ${i + 1} của ${images.length}...`;
                    
                    const result = await Tesseract.recognize(
                        images[i],
                        'vie+eng', // Tiếng Việt và tiếng Anh
                        {
                            logger: m => {
                                if (m.status === 'recognizing text') {
                                    progressBar.value = m.progress * 100;
                                }
                            }
                        }
                    );
                    
                    fullText += result.data.text + '\n\n';
                    progressBar.value = ((i + 1) / images.length) * 100;
                }
                
                extractedText.value = fullText;
                
                // Phân tích dữ liệu từ nội dung trích xuất
                parseInvoiceTables(fullText);
                
                status.textContent = 'Hoàn thành!';
            } catch (error) {
                console.error('Lỗi khi xử lý hóa đơn:', error);
                status.textContent = 'Lỗi: ' + error.message;
            }
        }
        
        // Chuyển PDF thành hình ảnh
        async function pdfToImages(file) {
            return new Promise((resolve, reject) => {
                const fileReader = new FileReader();
                
                fileReader.onload = async function() {
                    try {
                        const typedArray = new Uint8Array(this.result);
                        const pdf = await pdfjsLib.getDocument(typedArray).promise;
                        const images = [];
                        
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const viewport = page.getViewport({ scale: 2.0 });
                            
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            
                            await page.render({
                                canvasContext: context,
                                viewport: viewport
                            }).promise;
                            
                            images.push(canvas.toDataURL('image/jpeg', 0.8));
                        }
                        
                        resolve(images);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                fileReader.readAsArrayBuffer(file);
            });
        }
        
        // Phân tích bảng hàng hóa và chiết khấu từ nội dung
        function parseInvoiceTables(text) {
            // Xóa dữ liệu cũ
            itemsTableBody.innerHTML = '';
            discountsTableBody.innerHTML = '';
            
            // Biểu thức chính quy để tìm hàng trong bảng
            const rowRegex = /(\d+)\s*\|\s*([^|]+)\s*\|\s*([^|]*)\s*\|\s*([^|]+)\s*\|\s*([^|]+)\s*\|\s*([\d.,]+)\s*\|\s*([\d.,]+)\s*\|\s*([\d.,]+)%?\s*\|\s*([\d.,]+)/g;
            
            let match;
            while ((match = rowRegex.exec(text)) !== null) {
                const rowType = match[2].trim();
                
                if (rowType.includes('Hàng hóa') || rowType.includes('dịch vụ')) {
                    // Đây là hàng hóa/dịch vụ
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${match[1]}</td>
                        <td>${match[4].trim()}</td>
                        <td>${match[5].trim()}</td>
                        <td>${match[6].replace(/\./g, '').replace(',', '.')}</td>
                        <td>${match[7].replace(/\./g, '').replace(',', '.')}</td>
                        <td>${match[10].replace(/\./g, '').replace(',', '.')}</td>
                    `;
                    itemsTableBody.appendChild(row);
                } else if (rowType.includes('Chiết khấu')) {
                    // Đây là chiết khấu thương mại
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${match[4].trim()}</td>
                        <td>${match[10].replace(/\./g, '').replace(',', '.')}</td>
                    `;
                    discountsTableBody.appendChild(row);
                }
            }
            
            // Nếu không tìm thấy bằng regex, thử cách khác
            if (itemsTableBody.children.length === 0) {
                extractTablesManually(text);
            }
        }
        
        // Phương pháp dự phòng để trích xuất bảng
        function extractTablesManually(text) {
            const lines = text.split('\n');
            let inItemsTable = false;
            let inDiscountsTable = false;
            
            for (const line of lines) {
                // Phát hiện bắt đầu bảng hàng hóa
                if (line.includes('Tên hàng hóa, dịch vụ') || line.includes('Đơn vị tính')) {
                    inItemsTable = true;
                    inDiscountsTable = false;
                    continue;
                }
                
                // Phát hiện bắt đầu bảng chiết khấu
                if (line.includes('Chiết khấu thương mại')) {
                    inItemsTable = false;
                    inDiscountsTable = true;
                    continue;
                }
                
                // Xử lý hàng hóa
                if (inItemsTable && line.trim() && !line.includes('---')) {
                    const columns = line.split('|').map(col => col.trim()).filter(col => col);
                    if (columns.length >= 6) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${columns[0] || ''}</td>
                            <td>${columns[3] || ''}</td>
                            <td>${columns[4] || ''}</td>
                            <td>${columns[5] ? columns[5].replace(/\./g, '').replace(',', '.') : ''}</td>
                            <td>${columns[6] ? columns[6].replace(/\./g, '').replace(',', '.') : ''}</td>
                            <td>${columns[9] ? columns[9].replace(/\./g, '').replace(',', '.') : ''}</td>
                        `;
                        itemsTableBody.appendChild(row);
                    }
                }
                
                // Xử lý chiết khấu
                if (inDiscountsTable && line.trim() && !line.includes('---')) {
                    const columns = line.split('|').map(col => col.trim()).filter(col => col);
                    if (columns.length >= 2) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${columns[3] || ''}</td>
                            <td>${columns[9] ? columns[9].replace(/\./g, '').replace(',', '.') : ''}</td>
                        `;
                        discountsTableBody.appendChild(row);
                    }
                }
            }
        }
    </script>
</body>
</html>