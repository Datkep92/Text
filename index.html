<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Qu·∫£n l√Ω H·ªô Kinh Doanh</title>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #999; padding: 6px; text-align: left; font-size: 14px; }
    th { background-color: #eee; }
    td[contenteditable="true"] { background: #fffced; }
    button { padding: 8px 12px; margin: 10px 5px; }
    #summary { font-weight: bold; margin-top: 15px; padding: 10px; background: #f9f9f9; border: 1px solid #ccc; white-space: pre-line; }
    #pdfTextArea, #status { display: none; }
    .tabs { margin-bottom: 20px; }
    .tabs button { margin-right: 10px; }
    .tab { display: none; }
    .tab.active { display: block; }
    #businessList { margin-top: 20px; }
    #businessList ul { list-style: none; padding: 0; }
    #businessList li { padding: 10px; border: 1px solid #ddd; margin-bottom: 5px; cursor: pointer; }
    #businessList li:hover { background: #f0f0f0; }
    #businessDetails { margin-top: 20px; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; }
    #invoiceInfo { border: 1px dashed #999; padding: 10px; margin-top: 15px; background: #f3f3f3; white-space: pre-line; }
    #searchContainer { margin-bottom: 20px; }
    #searchInput { padding: 8px; width: 300px; }
    #searchResults { margin-top: 10px; }
  </style>
</head>
<body>
  <div id="searchContainer">
    <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm h√≥a ƒë∆°n, HKD, nh√† ph√¢n ph·ªëi...">
    <div id="searchResults"></div>
  </div>

  <div class="tabs">
    <button onclick="showTab('invoices')">Nh·∫≠p H√≥a ƒë∆°n</button>
    <button onclick="showTab('business')">H·ªô Kinh Doanh</button>
  </div>

  <div id="invoices" class="tab active">
    <h3>üìÇ Nh·∫≠p H√≥a ƒë∆°n</h3>
    <button onclick="document.getElementById('pdfInput').click()">üì• Ch·ªçn File H√≥a ƒë∆°n</button>
    <input type="file" id="pdfInput" accept="application/pdf" multiple style="display: none;">
    <div id="status">Ch∆∞a x·ª≠ l√Ω</div>
    <div id="invoiceInfo">üßæ Th√¥ng tin h√≥a ƒë∆°n s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y sau khi upload...</div>
    <textarea id="pdfTextArea"></textarea>
    <div id="tableResult"></div>
    <div id="summary">
      T·ªïng: <span id="totalQty">0</span> s·∫£n ph·∫©m |
      T·ªïng s·ªë ti·ªÅn: <span id="totalMoney">0</span><br>
      üßæ T·ªïng chi·∫øt kh·∫•u: <span id="totalDiscount">0</span><br>
      üí∞ T·ªïng sau chi·∫øt kh·∫•u: <span id="netTotal" contenteditable="true" oninput="manualNetEdit=true">0</span>
    </div>
  </div>

  <div id="business" class="tab">
    <h3>üìã Danh s√°ch H·ªô Kinh Doanh</h3>
    <button onclick="createManualBusiness()">‚ûï T·∫°o H·ªô Kinh Doanh</button>
    <button onclick="clearAllData()">üóëÔ∏è X√≥a To√†n B·ªô D·ªØ Li·ªáu</button>
    <div id="businessList"></div>
    <div id="businessDetails">
      <h4>Chi ti·∫øt H·ªô Kinh Doanh</h4>
      <div id="inventoryTable"></div>
      <div id="invoiceHistory"></div>
    </div>
  </div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.worker.min.js';

let businesses = JSON.parse(localStorage.getItem('businesses')) || [];
let invoices = JSON.parse(localStorage.getItem('invoices')) || [];
let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
let manualNetEdit = false;

function normalizeNumber(str) {
  if (!str) return 0;
  if (typeof str === 'number') return str;
  return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
}

function showTab(tabId) {
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
}

function extractInvoiceInfo(text) {
  const dateMatch = text.match(/Ng√†y[:\s]*(\d{2}) th√°ng (\d{2}) nƒÉm (\d{4})/i);
  return {
    mccqt: (text.match(/MCCQT[:\s]*([A-Z0-9]+)/i) || [])[1] || 'Kh√¥ng r√µ',
    so: (text.match(/S·ªë[:\s]+(\d{3,})/i) || [])[1] || 'Kh√¥ng r√µ',
    kyhieu: (text.match(/K√Ω hi·ªáu[:\s]+([A-Z0-9\/]+)/i) || [])[1] || 'Kh√¥ng r√µ',
    date: dateMatch ? `Ng√†y ${dateMatch[1]} th√°ng ${dateMatch[2]} nƒÉm ${dateMatch[3]}` : 'Kh√¥ng r√µ',
    tenBan: (text.match(/T√™n ng∆∞·ªùi b√°n[:\s]+([^\n]+)/i) || [])[1] || 'Kh√¥ng r√µ',
    mstBan: (text.match(/M√£ s·ªë thu·∫ø[:\s]+(\d{8,15})/i) || [])[1] || 'Kh√¥ng r√µ',
    diachiBan: (text.match(/ƒê·ªãa ch·ªâ[:\s]+([^\n]+)/i) || [])[1] || 'Kh√¥ng r√µ',
    tenMua: (text.match(/T√™n ng∆∞·ªùi mua[:\s]+([^\n]+)/i) || [])[1] || 'Kh√¥ng r√µ',
    mstMua: (text.match(/M√£ s·ªë thu·∫ø[:\s]+(\d{8,15})/gi) || []).slice(1).pop() || 'Kh√¥ng r√µ',
    diachiMua: (text.match(/ƒê·ªãa ch·ªâ[:\s]+([^\n]+)/gi) || []).slice(1).pop() || 'Kh√¥ng r√µ',
  };
}

document.getElementById('pdfInput').addEventListener('change', async (e) => {
  const files = e.target.files;
  if (!files.length) return;
  const status = document.getElementById('status');

  for (const file of files) {
    status.innerText = `üì• ƒêang x·ª≠ l√Ω ${file.name}...`;
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    let resultLines = [];
    let fullText = '';
    let direction = 'input';

    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      const rawTexts = content.items.map(item => item.str.trim()).filter(t => t !== '');
      fullText += rawTexts.join('\n') + '\n';
      if (rawTexts.some(txt => txt.toLowerCase().includes('xu·∫•t kho'))) direction = 'output';

      let currentLine = '';
      for (let txt of rawTexts) {
        if (txt.includes('Thu·∫ø su·∫•t')) break;
        currentLine += txt + ' ';
      }
      const splitLines = currentLine.match(/(\d+\s+(H√†ng h√≥a|Chi·∫øt kh·∫•u)[\s\S]*?)(?=\d+\s+(H√†ng h√≥a|Chi·∫øt kh·∫•u)|$)/g);
      if (splitLines) resultLines.push(...splitLines.map(s => s.trim()));
    }

    const info = extractInvoiceInfo(fullText);
    if (info.mccqt === 'Kh√¥ng r√µ') {
      alert(`Kh√¥ng t√¨m th·∫•y m√£ MCCQT trong ${file.name}`);
      continue;
    }
    if (invoices.some(inv => inv.mccqt === info.mccqt)) {
      alert(`H√≥a ƒë∆°n v·ªõi m√£ MCCQT ${info.mccqt} ƒë√£ t·ªìn t·∫°i`);
      continue;
    }
    if (info.mstMua === 'Kh√¥ng r√µ') {
      alert(`Kh√¥ng t√¨m th·∫•y MST ng∆∞·ªùi mua trong ${file.name}`);
      continue;
    }

    let business = businesses.find(b => b.taxCode === info.mstMua && b.name === info.tenMua);
    if (!business) {
      business = {
        id: crypto.randomUUID(),
        name: info.tenMua,
        taxCode: info.mstMua,
        address: info.diachiMua
      };
      businesses.push(business);
      localStorage.setItem('businesses', JSON.stringify(businesses));
    }

    document.getElementById('pdfTextArea').value = resultLines.join('\n');
    parseToTable(business.id, file, info, direction);
    status.innerText = `‚úÖ ƒê√£ x·ª≠ l√Ω ${file.name}`;
    updateBusinessList();
  }
});

function parseToTable(businessId, file, info, direction) {
  const rawText = document.getElementById('pdfTextArea').value.trim();
  const lines = rawText.split('\n').filter(line => line.trim() !== '');
  const rows = [];
  const invoice = {
    id: crypto.randomUUID(),
    businessId,
    mccqt: info.mccqt,
    number: info.so,
    series: info.kyhieu,
    date: info.date,
    seller: { name: info.tenBan, taxCode: info.mstBan, address: info.diachiBan },
    file: URL.createObjectURL(file),
    items: [],
    direction
  };

  for (const line of lines) {
    const tokens = line.trim().split(/\s+/);
    const stt = tokens.shift();
    const typeToken = tokens.slice(0, 3).join(' ');
    const isDiscount = /Chi·∫øt kh·∫•u/i.test(typeToken);
    let type = isDiscount ? 'Chi·∫øt kh·∫•u th∆∞∆°ng m·∫°i' : 'H√†ng h√≥a, d·ªãch v·ª•';
    tokens.splice(0, 3);

    let name = '', qty = '', price = '', discount = '0', vat = '0', total = '0', unit = '';

    if (isDiscount) {
      total = tokens.pop();
      vat = tokens.pop();
      const lastThree = tokens.splice(-3);
      discount = lastThree[0] || '0';
      price = lastThree[1] || '0';
      qty = lastThree[2] || '';
      name = tokens.join(' ');
    } else {
      const reversed = [...tokens].reverse();
      total = reversed.shift() || '0';
      vat = reversed.shift() || '0';
      discount = reversed.shift() || '0';
      price = reversed.shift() || '0';
      qty = reversed.shift() || '0';
      for (let i = 0; i < reversed.length; i++) {
        if (/[a-zA-Z√Ä-·ª¥√†-·ªµ]+/.test(reversed[i])) {
          unit = reversed[i];
          reversed.splice(i, 1);
          break;
        }
      }
      name = reversed.reverse().join(' ');
    }

    name = name.replace(/^m·∫°i\s*/i, '').replace(/^v·ª•\s*/i, '');
    rows.push({ stt, type, name, unit, qty, price, discount, vat, total });
    invoice.items.push({ stt, type, name, unit, qty, price, discount, vat, total });
    if (type === 'H√†ng h√≥a, d·ªãch v·ª•') {
      updateInventory(businessId, { stt, type, name, unit, qty, price, discount, vat, total }, direction);
    }
  }

  invoices.push(invoice);
  localStorage.setItem('invoices', JSON.stringify(invoices));

  document.getElementById('invoiceInfo').innerText =
`üßæ H√ìA ƒê∆†N: ${info.kyhieu} - ${info.so}
üîê M√£ MCCQT: ${info.mccqt}
üìÖ Ng√†y: ${info.date}

üë§ NG∆Ø·ªúI MUA:
- T√™n: ${info.tenMua}
- MST: ${info.mstMua}
- ƒê·ªãa ch·ªâ: ${info.diachiMua}

üè¢ NG∆Ø·ªúI B√ÅN:
- T√™n: ${info.tenBan}
- MST: ${info.mstBan}
- ƒê·ªãa ch·ªâ: ${info.diachiBan}`;

  const headers = ['STT', 'T√≠nh ch·∫•t', 'T√™n h√†ng h√≥a, d·ªãch v·ª•', 'ƒê∆°n v·ªã t√≠nh', 'S·ªë l∆∞·ª£ng', 'ƒê∆°n gi√°', 'Chi·∫øt kh·∫•u', 'Thu·∫ø su·∫•t', 'Th√†nh ti·ªÅn'];
  let html = '<table><thead><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead><tbody>';

  for (const row of rows) {
    html += `<tr>` + [
      row.stt, row.type, row.name, row.unit,
      `<span class="qty" contenteditable="true">${row.qty}</span>`,
      `<span class="price" contenteditable="true">${row.price}</span>`,
      `<span contenteditable="true">${row.discount}</span>`,
      `<span contenteditable="true">${row.vat}</span>`,
      `<span class="total">${formatMoney(row.total)}</span>`
    ].map(cell => `<td>${cell}</td>`).join('') + '</tr>';
  }

  html += '</tbody></table><button onclick="addEmptyRow()">‚ûï Th√™m s·∫£n ph·∫©m</button>';
  document.getElementById('tableResult').innerHTML = html;

  document.querySelectorAll('.qty, .price').forEach(span =>
    span.addEventListener('input', updateComputedTotals)
  );
  updateComputedTotals();
}

function updateInventory(businessId, item, direction) {
  const invItem = inventory.find(i => i.businessId === businessId && i.name === item.name);
  const qtyChange = normalizeNumber(item.qty) * (direction === 'input' ? 1 : -1);
  if (invItem) {
    invItem.qty += qtyChange;
    invItem.price = item.price;
    invItem.discount = item.discount;
    invItem.vat = item.vat;
    invItem.total = formatMoney(normalizeNumber(invItem.qty) * normalizeNumber(item.price));
  } else if (qtyChange > 0) {
    inventory.push({
      businessId,
      stt: item.stt,
      type: item.type,
      name: item.name,
      unit: item.unit,
      qty: qtyChange,
      price: item.price,
      discount: item.discount,
      vat: item.vat,
      total: formatMoney(qtyChange * normalizeNumber(item.price))
    });
  }
  localStorage.setItem('inventory', JSON.stringify(inventory));
}

function updateBusinessList() {
  const businessList = document.getElementById('businessList');
  businessList.innerHTML = '<ul>' + businesses.map(b => `
    <li onclick="showBusinessDetails('${b.id}')">
      ${b.name} (MST: ${b.taxCode}) 
      <button onclick="editBusinessName('${b.id}', event)">S·ª≠a t√™n</button>
    </li>
  `).join('') + '</ul>';
  localStorage.setItem('businesses', JSON.stringify(businesses));
}

function createManualBusiness() {
  const name = prompt('Nh·∫≠p t√™n H·ªô Kinh Doanh:');
  const taxCode = prompt('Nh·∫≠p MST:');
  if (name && taxCode && !businesses.find(b => b.taxCode === taxCode && b.name === name)) {
    const newBusiness = {
      id: crypto.randomUUID(),
      name,
      taxCode,
      address: prompt('Nh·∫≠p ƒë·ªãa ch·ªâ (t√πy ch·ªçn):') || ''
    };
    businesses.push(newBusiness);
    localStorage.setItem('businesses', JSON.stringify(businesses));
    updateBusinessList();
  } else {
    alert('T√™n ho·∫∑c MST kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ t·ªìn t·∫°i!');
  }
}

function editBusinessName(businessId, event) {
  event.stopPropagation();
  const business = businesses.find(b => b.id === businessId);
  const newName = prompt('Nh·∫≠p t√™n m·ªõi cho H·ªô Kinh Doanh:', business.name);
  if (newName && newName !== business.name) {
    business.name = newName;
    localStorage.setItem('businesses', JSON.stringify(businesses));
    updateBusinessList();
    showBusinessDetails(businessId);
  }
}

function clearAllData() {
  if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu (HKD, h√≥a ƒë∆°n, t·ªìn kho)?')) {
    businesses = [];
    invoices = [];
    inventory = [];
    localStorage.setItem('businesses', JSON.stringify(businesses));
    localStorage.setItem('invoices', JSON.stringify(invoices));
    localStorage.setItem('inventory', JSON.stringify(inventory));
    updateBusinessList();
    document.getElementById('businessDetails').innerHTML = '<h4>Chi ti·∫øt H·ªô Kinh Doanh</h4>';
    alert('ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu!');
  }
}

function showBusinessDetails(businessId) {
  const business = businesses.find(b => b.id === businessId);
  if (!business) return;

  const inv = inventory.filter(i => i.businessId === businessId);
  const invTable = `
    <h4>T·ªìn kho</h4>
    <table>
      <thead>
        <tr>
          <th>STT</th><th>T√≠nh ch·∫•t</th><th>T√™n h√†ng h√≥a, d·ªãch v·ª•</th><th>ƒê∆°n v·ªã t√≠nh</th>
          <th>S·ªë l∆∞·ª£ng</th><th>ƒê∆°n gi√°</th><th>Chi·∫øt kh·∫•u</th><th>Thu·∫ø su·∫•t</th><th>Th√†nh ti·ªÅn</th>
        </tr>
      </thead>
      <tbody>
        ${inv.map(i => `
          <tr>
            <td>${i.stt}</td><td>${i.type}</td><td>${i.name}</td><td>${i.unit}</td>
            <td>${i.qty}</td><td>${formatMoney(i.price)}</td><td>${formatMoney(i.discount)}</td>
            <td>${i.vat}</td><td>${i.total}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;

  const history = invoices.filter(i => i.businessId === businessId);
  const historyTable = `
    <h4>L·ªãch s·ª≠ h√≥a ƒë∆°n</h4>
    <table>
      <thead><tr><th>S·ªë Hƒê</th><th>MCCQT</th><th>Ng√†y</th><th>Lo·∫°i</th><th>Thao t√°c</th></tr></thead>
      <tbody>
        ${history.map(i => `
          <tr>
            <td>${i.series}-${i.number}</td>
            <td>${i.mccqt}</td>
            <td>${i.date}</td>
            <td>${i.direction === 'input' ? 'Nh·∫≠p' : 'Xu·∫•t'}</td>
            <td><a href="${i.file}" target="_blank">Xem</a></td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;

  document.getElementById('businessDetails').innerHTML = `
    <h4>${business.name} (MST: ${business.taxCode})</h4>
    <p>ƒê·ªãa ch·ªâ: ${business.address || 'N/A'}</p>
    ${invTable}
    ${historyTable}
  `;
}

function formatMoney(number) {
  const n = Math.floor(normalizeNumber(number));
  return n.toLocaleString('vi-VN');
}

function addEmptyRow() {
  const table = document.querySelector('#tableResult table tbody');
  const newRow = document.createElement('tr');
  newRow.innerHTML = `
    <td>#</td>
    <td>H√†ng h√≥a, d·ªãch v·ª•</td>
    <td contenteditable="true">T√™n s·∫£n ph·∫©m m·ªõi</td>
    <td contenteditable="true">C√°i</td>
    <td><span class="qty" contenteditable="true">0</span></td>
    <td><span class="price" contenteditable="true">0</span></td>
    <td contenteditable="true">0</td>
    <td contenteditable="true">0%</td>
    <td><span class="total">0</span></td>
  `;
  table.appendChild(newRow);
  newRow.querySelectorAll('.qty, .price').forEach(span =>
    span.addEventListener('input', updateComputedTotals)
  );
  updateComputedTotals();
}

function updateComputedTotals() {
  let totalQty = 0;
  let totalMoney = 0;
  let totalDiscount = 0;

  document.querySelectorAll('#tableResult tbody tr').forEach(row => {
    const type = row.children[1].innerText.trim();
    const qtyEl = row.querySelector('.qty');
    const priceEl = row.querySelector('.price');
    const totalEl = row.querySelector('.total');

    const qty = normalizeNumber(qtyEl?.innerText);
    const price = normalizeNumber(priceEl?.innerText);
    const computed = qty * price;

    if (type === 'H√†ng h√≥a, d·ªãch v·ª•') {
      totalQty += qty;
      totalMoney += computed;
      totalEl.innerText = formatMoney(computed);
    } else {
      const total = normalizeNumber(totalEl.innerText);
      totalDiscount += total;
      totalEl.innerText = formatMoney(total);
    }
  });

  if (!manualNetEdit) {
    const net = totalMoney - totalDiscount;
    document.getElementById('netTotal').innerText = formatMoney(net);
  }

  document.getElementById('totalQty').innerText = formatMoney(totalQty);
  document.getElementById('totalMoney').innerText = formatMoney(totalMoney);
  document.getElementById('totalDiscount').innerText = formatMoney(totalDiscount);
}

document.getElementById('searchInput').addEventListener('input', function(e) {
  const query = e.target.value.toLowerCase().trim();
  const results = document.getElementById('searchResults');
  if (!query) {
    results.innerHTML = '';
    return;
  }

  const invoiceMatches = invoices.filter(i => 
    i.mccqt.toLowerCase().includes(query) ||
    i.number.toLowerCase().includes(query) ||
    i.series.toLowerCase().includes(query)
  );

  const businessMatches = businesses.filter(b =>
    b.name.toLowerCase().includes(query) ||
    b.taxCode.toLowerCase().includes(query)
  );

  const distributorMatches = invoices.filter(i =>
    i.seller.name.toLowerCase().includes(query) ||
    i.seller.taxCode.toLowerCase().includes(query)
  ).map(i => i.seller);

  let html = '';
  if (invoiceMatches.length) {
    html += '<h4>H√≥a ƒë∆°n</h4><ul>' + invoiceMatches.map(i => `
      <li onclick="showBusinessDetails('${i.businessId}')">
        ${i.series}-${i.number} (MCCQT: ${i.mccqt}, Ng√†y: ${i.date})
      </li>
    `).join('') + '</ul>';
  }
  if (businessMatches.length) {
    html += '<h4>H·ªô Kinh Doanh</h4><ul>' + businessMatches.map(b => `
      <li onclick="showBusinessDetails('${b.id}')">
        ${b.name} (MST: ${b.taxCode})
      </li>
    `).join('') + '</ul>';
  }
  if (distributorMatches.length) {
    html += '<h4>Nh√† ph√¢n ph·ªëi</h4><ul>' + [...new Set(distributorMatches.map(d => d.name + d.taxCode))].map(d => {
      const seller = distributorMatches.find(s => (s.name + s.taxCode) === d);
      return `<li>${seller.name} (MST: ${seller.taxCode})</li>`;
    }).join('') + '</ul>';
  }

  results.innerHTML = html || 'Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£';
});

updateBusinessList();
document.getElementById('business').classList.add('active'); // Show HKD list by default
</script>
</body>
</html>