<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Extraction and Inventory Management</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1, h2 {
            color: #2c3e50;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 5px;
            background-color: #f9f9f9;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .flex-container {
            display: flex;
            gap: 20px;
        }
        .upload-section {
            flex: 1;
        }
        .results-section {
            flex: 2;
        }
        textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .progress-container {
            margin-top: 10px;
            display: none;
        }
        progress {
            width: 100%;
        }
        .status {
            margin-top: 5px;
            font-size: 14px;
            color: #666;
        }
        .search-section {
            margin-bottom: 20px;
        }
        input[type="text"] {
            padding: 8px;
            width: 300px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .invoice-details {
            margin-top: 20px;
        }
        .inventory-summary {
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Invoice Extraction and Inventory Management</h1>
        
        <div class="flex-container">
            <div class="section upload-section">
                <h2>Upload Invoice PDF</h2>
                <input type="file" id="fileInput" accept=".pdf,.png,.jpg,.jpeg">
                <div class="progress-container" id="progressContainer">
                    <progress id="progressBar" value="0" max="100"></progress>
                    <div class="status" id="status">Ready</div>
                </div>
                <button id="extractBtn">Extract Data</button>
            </div>
            
            <div class="section results-section">
                <h2>Extracted Data</h2>
                <textarea id="extractedText" readonly></textarea>
                <div class="invoice-details" id="invoiceDetails"></div>
            </div>
        </div>
        
        <div class="section search-section">
            <h2>Search Invoices</h2>
            <div>
                <label for="searchBuyer">Search by Buyer Name:</label>
                <input type="text" id="searchBuyer" placeholder="Enter buyer name">
                <button id="searchBuyerBtn">Search</button>
            </div>
            <div style="margin-top: 10px;">
                <label for="searchInvoice">Search by Invoice Number:</label>
                <input type="text" id="searchInvoice" placeholder="Enter invoice number">
                <button id="searchInvoiceBtn">Search</button>
            </div>
        </div>
        
        <div class="section">
            <h2>Invoice Records</h2>
            <table id="invoiceTable">
                <thead>
                    <tr>
                        <th>Invoice No.</th>
                        <th>Date</th>
                        <th>Buyer Name</th>
                        <th>Buyer Tax Code</th>
                        <th>Total Amount</th>
                        <th>Items Count</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="invoiceTableBody">
                    <!-- Invoice data will be inserted here -->
                </tbody>
            </table>
        </div>
        
        <div class="section inventory-summary">
            <h2>Inventory Summary</h2>
            <table id="inventoryTable">
                <thead>
                    <tr>
                        <th>Product Name</th>
                        <th>Quantity</th>
                        <th>Unit</th>
                        <th>Unit Price</th>
                        <th>Total Value</th>
                        <th>Last Purchase Date</th>
                    </tr>
                </thead>
                <tbody id="inventoryTableBody">
                    <!-- Inventory data will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Initialize database
        let invoiceDatabase = JSON.parse(localStorage.getItem('invoiceDatabase')) || [];
        let inventoryDatabase = JSON.parse(localStorage.getItem('inventoryDatabase')) || [];
        
        // DOM elements
        const fileInput = document.getElementById('fileInput');
        const extractBtn = document.getElementById('extractBtn');
        const extractedText = document.getElementById('extractedText');
        const invoiceDetails = document.getElementById('invoiceDetails');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const status = document.getElementById('status');
        const searchBuyer = document.getElementById('searchBuyer');
        const searchBuyerBtn = document.getElementById('searchBuyerBtn');
        const searchInvoice = document.getElementById('searchInvoice');
        const searchInvoiceBtn = document.getElementById('searchInvoiceBtn');
        const invoiceTableBody = document.getElementById('invoiceTableBody');
        const inventoryTableBody = document.getElementById('inventoryTableBody');
        
        // Initialize PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
        
        // Event listeners
        extractBtn.addEventListener('click', processInvoice);
        searchBuyerBtn.addEventListener('click', () => searchInvoices('buyer', searchBuyer.value));
        searchInvoiceBtn.addEventListener('click', () => searchInvoices('invoice', searchInvoice.value));
        
        // Load existing data on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateInvoiceTable();
            updateInventoryTable();
        });
        
        // Process invoice PDF
        async function processInvoice() {
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a PDF file first');
                return;
            }
            
            progressContainer.style.display = 'block';
            status.textContent = 'Processing...';
            progressBar.value = 0;
            
            try {
                // Convert PDF to images
                const images = await pdfToImages(file);
                let fullText = '';
                
                // Process each page with Tesseract
                for (let i = 0; i < images.length; i++) {
                    status.textContent = `Processing page ${i + 1} of ${images.length}...`;
                    
                    const result = await Tesseract.recognize(
                        images[i],
                        'vie+eng', // Vietnamese and English
                        {
                            logger: m => {
                                if (m.status === 'recognizing text') {
                                    progressBar.value = m.progress * 100;
                                }
                            }
                        }
                    );
                    
                    fullText += result.data.text + '\n\n';
                    progressBar.value = ((i + 1) / images.length) * 100;
                }
                
                extractedText.value = fullText;
                
                // Parse invoice data
                const invoiceData = parseInvoiceData(fullText);
                displayInvoiceDetails(invoiceData);
                
                // Save to database
                saveInvoiceData(invoiceData);
                
                status.textContent = 'Processing complete!';
            } catch (error) {
                console.error('Error processing invoice:', error);
                status.textContent = 'Error: ' + error.message;
            }
        }
        
        // Convert PDF to images
        async function pdfToImages(file) {
            return new Promise((resolve, reject) => {
                const fileReader = new FileReader();
                
                fileReader.onload = async function() {
                    try {
                        const typedArray = new Uint8Array(this.result);
                        const pdf = await pdfjsLib.getDocument(typedArray).promise;
                        const images = [];
                        
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const viewport = page.getViewport({ scale: 2.0 });
                            
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            
                            await page.render({
                                canvasContext: context,
                                viewport: viewport
                            }).promise;
                            
                            images.push(canvas.toDataURL('image/jpeg', 0.8));
                        }
                        
                        resolve(images);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                fileReader.readAsArrayBuffer(file);
            });
        }
        
        // Parse invoice data from text
        function parseInvoiceData(text) {
            const invoiceData = {
                invoiceNumber: extractValue(text, /Số:\s*([^\n]+)/) || 'N/A',
                date: extractValue(text, /Ngày\s*(\d{2}\s*tháng\s*\d{2}\s*năm\s*\d{4})/),
                seller: {
                    name: extractValue(text, /Tên người bán:\s*([^\n]+)/),
                    taxCode: extractValue(text, /Mã số thuế:\s*([^\n]+)/),
                    address: extractValue(text, /Địa chỉ:\s*([^\n]+)/),
                    phone: extractValue(text, /Điện thoại:\s*([^\n]+)/)
                },
                buyer: {
                    name: extractValue(text, /Tên người mua:\s*([^\n]+)/) || 
                          extractValue(text, /Họ tên người mua hàng:\s*([^\n]+)/) || 
                          extractValue(text, /HỘ KINH DOANH\s*([^\n]+)/),
                    taxCode: extractValue(text, /Mã số thuế:\s*([^\n]+)/, 1),
                    address: extractValue(text, /Địa chỉ:\s*([^\n]+)/, 1)
                },
                paymentMethod: extractValue(text, /Hình thức thanh toán:\s*([^\n]+)/),
                currency: extractValue(text, /Đơn vị tiền tệ:\s*([^\n]+)/),
                items: [],
                discounts: [],
                totalBeforeTax: extractNumber(text, /Tổng tiền chưa thuế[^\d]*([\d.,]+)/),
                totalTax: extractNumber(text, /Tổng tiền thuế[^\d]*([\d.,]+)/),
                totalAmount: extractNumber(text, /Tổng tiền thanh toán bằng số[^\d]*([\d.,]+)/),
                amountInWords: extractValue(text, /Tổng tiền thanh toán bằng chữ[^\n]*:\s*([^\n]+)/)
            };
            
            // Extract items from table
            const itemRegex = /(\d+)\s*\|\s*([^|]+)\s*\|\s*([^|]*)\s*\|\s*([^|]+)\s*\|\s*([^|]+)\s*\|\s*([\d.,]+)\s*\|\s*([\d.,]+)\s*\|\s*([\d.,]+)%?\s*\|\s*([\d.,]+)/g;
            let match;
            
            while ((match = itemRegex.exec(text)) !== null) {
                if (match[2].includes('Hàng hóa') || match[2].includes('dịch vụ')) {
                    invoiceData.items.push({
                        stt: match[1],
                        type: match[2].trim(),
                        specialType: match[3].trim(),
                        name: match[4].trim(),
                        unit: match[5].trim(),
                        quantity: parseFloat(match[6].replace(/\./g, '').replace(',', '.')),
                        unitPrice: parseFloat(match[7].replace(/\./g, '').replace(',', '.')),
                        discount: parseFloat(match[8].replace(/\./g, '').replace(',', '.')),
                        taxRate: parseFloat(match[9].replace(',', '.')),
                        amount: parseFloat(match[10].replace(/\./g, '').replace(',', '.'))
                    });
                } else if (match[2].includes('Chiết khấu')) {
                    invoiceData.discounts.push({
                        description: match[4].trim(),
                        amount: parseFloat(match[10].replace(/\./g, '').replace(',', '.'))
                    });
                }
            }
            
            return invoiceData;
        }
        
        // Helper function to extract value from text
        function extractValue(text, regex, index = 1) {
            const match = text.match(regex);
            return match ? match[index].trim() : null;
        }
        
        // Helper function to extract number from text
        function extractNumber(text, regex) {
            const value = extractValue(text, regex);
            return value ? parseFloat(value.replace(/\./g, '').replace(',', '.')) : 0;
        }
        
        // Display parsed invoice details
        function displayInvoiceDetails(data) {
            let html = `
                <h3>Invoice Details</h3>
                <p><strong>Invoice Number:</strong> ${data.invoiceNumber}</p>
                <p><strong>Date:</strong> ${data.date}</p>
                <p><strong>Buyer:</strong> ${data.buyer.name} (${data.buyer.taxCode})</p>
                <p><strong>Seller:</strong> ${data.seller.name} (${data.seller.taxCode})</p>
                <p><strong>Total Amount:</strong> ${formatCurrency(data.totalAmount)} ${data.currency}</p>
                <p><strong>Items:</strong> ${data.items.length}</p>
                
                <h4>Items List</h4>
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>Quantity</th>
                            <th>Unit</th>
                            <th>Unit Price</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.items.forEach(item => {
                html += `
                    <tr>
                        <td>${item.stt}</td>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>${item.unit}</td>
                        <td>${formatCurrency(item.unitPrice)}</td>
                        <td>${formatCurrency(item.amount)}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            invoiceDetails.innerHTML = html;
        }
        
        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { 
                style: 'currency', 
                currency: 'VND' 
            }).format(amount);
        }
        
        // Save invoice data to database
        function saveInvoiceData(data) {
            // Check if invoice already exists
            const existingIndex = invoiceDatabase.findIndex(
                inv => inv.invoiceNumber === data.invoiceNumber && inv.date === data.date
            );
            
            if (existingIndex >= 0) {
                // Update existing invoice
                invoiceDatabase[existingIndex] = data;
            } else {
                // Add new invoice
                invoiceDatabase.push(data);
            }
            
            // Update inventory
            updateInventory(data);
            
            // Save to localStorage
            localStorage.setItem('invoiceDatabase', JSON.stringify(invoiceDatabase));
            localStorage.setItem('inventoryDatabase', JSON.stringify(inventoryDatabase));
            
            // Update UI
            updateInvoiceTable();
            updateInventoryTable();
            
            alert('Invoice data saved successfully!');
        }
        
        // Update inventory database
        function updateInventory(invoiceData) {
            invoiceData.items.forEach(item => {
                const existingItem = inventoryDatabase.find(
                    invItem => invItem.name === item.name && invItem.unit === item.unit
                );
                
                if (existingItem) {
                    // Update existing item
                    existingItem.quantity += item.quantity;
                    existingItem.unitPrice = item.unitPrice; // Update with latest price
                    existingItem.lastPurchaseDate = invoiceData.date;
                } else {
                    // Add new item
                    inventoryDatabase.push({
                        name: item.name,
                        quantity: item.quantity,
                        unit: item.unit,
                        unitPrice: item.unitPrice,
                        lastPurchaseDate: invoiceData.date
                    });
                }
            });
        }
        
        // Update invoice table
        function updateInvoiceTable(filteredData = null) {
            const dataToDisplay = filteredData || invoiceDatabase;
            
            invoiceTableBody.innerHTML = dataToDisplay.map(invoice => `
                <tr>
                    <td>${invoice.invoiceNumber}</td>
                    <td>${invoice.date}</td>
                    <td>${invoice.buyer.name}</td>
                    <td>${invoice.buyer.taxCode}</td>
                    <td>${formatCurrency(invoice.totalAmount)}</td>
                    <td>${invoice.items.length}</td>
                    <td>
                        <button onclick="viewInvoiceDetails('${invoice.invoiceNumber}')">View</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Update inventory table
        function updateInventoryTable() {
            inventoryTableBody.innerHTML = inventoryDatabase.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${item.unit}</td>
                    <td>${formatCurrency(item.unitPrice)}</td>
                    <td>${formatCurrency(item.quantity * item.unitPrice)}</td>
                    <td>${item.lastPurchaseDate}</td>
                </tr>
            `).join('');
        }
        
        // Search invoices
        function searchInvoices(type, query) {
            if (!query.trim()) {
                updateInvoiceTable();
                return;
            }
            
            const filtered = invoiceDatabase.filter(invoice => {
                if (type === 'buyer') {
                    return invoice.buyer.name.toLowerCase().includes(query.toLowerCase());
                } else if (type === 'invoice') {
                    return invoice.invoiceNumber.toLowerCase().includes(query.toLowerCase());
                }
                return false;
            });
            
            updateInvoiceTable(filtered);
        }
        
        // View invoice details
        function viewInvoiceDetails(invoiceNumber) {
            const invoice = invoiceDatabase.find(inv => inv.invoiceNumber === invoiceNumber);
            if (invoice) {
                extractedText.value = JSON.stringify(invoice, null, 2);
                displayInvoiceDetails(invoice);
            }
        }
        
        // Make functions available globally
        window.viewInvoiceDetails = viewInvoiceDetails;
    </script>
</body>
</html>