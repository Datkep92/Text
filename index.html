<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Tr√≠ch xu·∫•t b·∫£ng k√™ ho√° ƒë∆°n PDF - Ch·ªçn th·ªß c√¥ng</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    textarea, pre { width: 100%; height: 200px; font-family: monospace; }
    .highlight { background-color: #dff0d8; }
    .clickable { cursor: pointer; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 5px; font-size: 13px; }
    input { width: 100%; }
    .btn-small { font-size: 11px; padding: 2px 5px; }
  </style>
</head>
<body>

<h3>üìÑ B1: T·∫£i file PDF ‚Üí Hi·ªÉn th·ªã to√†n b·ªô n·ªôi dung</h3>
<input type="file" id="pdfInput" accept="application/pdf">
<p><b>üñ±Ô∏è Click d√≤ng b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c b·∫£ng k√™ ƒë·ªÉ ch·ªçn v√πng c·∫ßn ph√¢n t√≠ch.</b></p>
<pre id="textLines"></pre>

<h3>üìä B2: K·∫øt qu·∫£ b·∫£ng k√™</h3>
<div id="result"></div>

<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.worker.min.js';

let allLines = [];
let selectedStart = null;
let selectedEnd = null;

function removeVN(str) {
  return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/ƒë/g, "d").replace(/ƒê/g, "D");
}

function groupTextByY(items) {
  const lines = {};
  for (const item of items) {
    const y = Math.round(item.transform[5]);
    const x = item.transform[4];
    if (!lines[y]) lines[y] = [];
    lines[y].push({ x, str: item.str });
  }

  const sortedY = Object.keys(lines).sort((a, b) => b - a);
  return sortedY.map((y) =>
    lines[y].sort((a, b) => a.x - b.x).map((t) => t.str).join(' ')
  );
}

document.getElementById('pdfInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

  allLines = [];

  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    const lines = groupTextByY(content.items);
    allLines.push(...lines);
  }

  renderLineSelector();
});

function renderLineSelector() {
  const container = document.getElementById('textLines');
  container.innerHTML = '';
  allLines.forEach((line, index) => {
    const div = document.createElement('div');
    div.textContent = `${index + 1}. ${removeVN(line)}`;
    div.className = 'clickable';
    div.onclick = () => handleLineClick(index);
    container.appendChild(div);
  });
}

function handleLineClick(index) {
  if (selectedStart === null || (selectedStart !== null && selectedEnd !== null)) {
    selectedStart = index;
    selectedEnd = null;
  } else {
    selectedEnd = index;
    if (selectedStart > selectedEnd) [selectedStart, selectedEnd] = [selectedEnd, selectedStart];
    processSelectedLines();
  }
  updateHighlights();
}

function updateHighlights() {
  const lines = document.querySelectorAll('#textLines div');
  lines.forEach((div, idx) => {
    if (selectedStart !== null && selectedEnd === null && idx === selectedStart)
      div.classList.add('highlight');
    else if (selectedStart !== null && selectedEnd !== null &&
      idx >= selectedStart && idx <= selectedEnd)
      div.classList.add('highlight');
    else
      div.classList.remove('highlight');
  });
}

function processSelectedLines() {
  const selected = allLines.slice(selectedStart, selectedEnd + 1);
  const data = [];

  selected.forEach((line) => {
    const parts = line.trim().split(/\s+/);
    if (parts.length < 6) return;

    const last = parts.slice(-6);
    if (!last[0] || !isNaN(last[0]) === false) return; // b·ªè d√≤ng kh√¥ng c√≥ DVT

    let name = parts.slice(0, parts.length - 6).join(' ');
    name = name.replace(/^\d+\s*/, '').replace(/^Hang\s*/i, '');

    const sl = parseFloat(last[1].replace(',', '.')) || 0;
    const dg = parseFloat(last[2].replace(/\./g, '').replace(',', '.')) || 0;
    const tt = sl * dg;

    data.push({
      ten: name,
      dvt: last[0],
      sl: sl,
      gia: dg,
      ck: last[3],
      thue: last[4],
      tt: tt
    });
  });

  renderTable(data);
}

function renderTable(data) {
  const result = document.getElementById('result');
  if (data.length === 0) {
    result.innerHTML = '<i>Kh√¥ng c√≥ d·ªØ li·ªáu</i>';
    return;
  }

  let html = `<table id="itemTable">
    <thead><tr>
      <th>STT</th><th>T√™n h√†ng</th><th>ƒêVT</th><th>S·ªë l∆∞·ª£ng</th>
      <th>ƒê∆°n gi√°</th><th>Chi·∫øt kh·∫•u</th><th>Thu·∫ø su·∫•t</th><th>Th√†nh ti·ªÅn</th>
      <th></th>
    </tr></thead><tbody>`;

  data.forEach((p, i) => {
    html += `<tr>
      <td>${i + 1}</td>
      <td><input value="${p.ten}"></td>
      <td><input value="${p.dvt}"></td>
      <td><input class="sl" type="number" value="${p.sl}" oninput="updateTotals()"></td>
      <td><input class="dg" type="text" value="${p.gia.toLocaleString('vi-VN')}" oninput="updateTotals()"></td>
      <td><input value="${p.ck}"></td>
      <td><input value="${p.thue}"></td>
      <td><input class="tt" type="text" value="${p.tt.toLocaleString('vi-VN')}" readonly></td>
      <td><button class="btn-small" onclick="this.closest('tr').remove(); updateTotals()">‚ùå</button></td>
    </tr>`;
  });

  html += `</tbody>
    <tfoot>
      <tr>
        <td colspan="3"><b>T·ªïng</b></td>
        <td id="totalQty" class="center">0</td>
        <td></td><td></td><td></td>
        <td id="totalAmt" class="center">0</td>
        <td></td>
      </tr>
    </tfoot>
  </table>
  <button onclick="addRow()">‚ûï Th√™m h√†ng</button>`;

  result.innerHTML = html;
  updateTotals();
}

function addRow() {
  const tbody = document.querySelector('#itemTable tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>#</td><td><input></td><td><input></td>
    <td><input class="sl" type="number" value="0" oninput="updateTotals()"></td>
    <td><input class="dg" type="text" value="0" oninput="updateTotals()"></td>
    <td><input></td><td><input></td>
    <td><input class="tt" type="text" value="0" readonly></td>
    <td><button class="btn-small" onclick="this.closest('tr').remove(); updateTotals()">‚ùå</button></td>`;
  tbody.appendChild(tr);
  updateTotals();
}

function updateTotals() {
  let totalQty = 0, totalAmt = 0;
  document.querySelectorAll('#itemTable tbody tr').forEach((row, i) => {
    row.children[0].innerText = i + 1;
    const sl = parseFloat(row.querySelector('.sl')?.value) || 0;
    const dgRaw = row.querySelector('.dg')?.value || '0';
    const dg = parseFloat(dgRaw.replace(/\./g, '').replace(',', '.')) || 0;
    const tt = sl * dg;
    row.querySelector('.tt').value = tt.toLocaleString('vi-VN');
    totalQty += sl;
    totalAmt += tt;
  });
  document.getElementById('totalQty').innerText = totalQty;
  document.getElementById('totalAmt').innerText = totalAmt.toLocaleString('vi-VN');
}
</script>
</body>
</html>